"use strict";var app=angular.module("waterApp",["ui.router","ngResource","firebase","chart.js"]).constant("fb",{url:"https://water-ma.firebaseio.com/"}).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/home.html",controller:"HomeController"}}}).state("post",{url:"/newspost/:id",views:{content:{templateUrl:"views/post.html",controller:"PostController"}}}).state("dashboard",{url:"/dashboard",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/information.html",controller:"DashboardController"}}}).state("send",{url:"/send",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/send.html"}}}),t.otherwise("/")}]);app.controller("DashboardController",["$scope","dashboardFactory","newsFactory",function(e,t,r){function o(r){e[r+"Data"]=t.getMetricsByWeek(r),e[r+"Data"].$loaded().then(function(){e.$watchCollection(r+"Data",function(t,o){e[r+"Labels"]=[],e[r+"Series"]=[r],e[r+"CurrentMetrics"]=[[]],t.forEach(function(t,o,a){var n,s=new Date(t.timestamp);switch(s.getDay()){case 0:n="Вс";break;case 1:n="Пн";break;case 2:n="Вт";break;case 3:n="Ср";break;case 4:n="Чт";break;case 5:n="Пт";break;case 6:n="Сб"}e[r+"Labels"][o]=n+", "+s.getDate(),e[r+"CurrentMetrics"][0][o]=t.contents})})})}e.biolMetrics=t.getMetrics("biol"),e.radMetrics=t.getMetrics("rad"),e.addGood=function(t){e[t+"Metrics"].$add({contents:0,timestamp:Firebase.ServerValue.TIMESTAMP})},e.addBad=function(t){var r=Math.floor(10*Math.random());e[t+"Metrics"].$add({contents:r,timestamp:Firebase.ServerValue.TIMESTAMP})},o("biol"),o("rad"),e.posts=r.getPosts(),e.addPost=function(){e.posts.$add({name:e.name,description:e.description,content:e.content,timestamp:Firebase.ServerValue.TIMESTAMP}),e.name="",e.description="",e.content=""}}]).controller("HomeController",["$scope","$resource","newsFactory",function(e,t,r){function o(r){i=r.coords.longitude,s=r.coords.latitude,n="http://api.openweathermap.org/data/2.5/weather?lat="+s+"&lon="+i+"&appid=44db6a862fba0b067b1930da0d769e98",console.log("current position is: "+s+" "+i),t(n).get().$promise.then(function(t){e.temperature=Math.round(t.main.temp-273),e.city=t.name,e.showWeather=!0;var r=t.weather[0].icon;"n"==r[r.length-1]?e.weathericon="wi wi-owm-night-"+t.weather[0].id:e.weathericon="wi-owm-day-"+t.weather[0].id},function(t){e.message="Error: "+t.status+" "+t.statusText})}function a(e){alert("error "+e.code+" "+e.message)}e.showWeather=!1,e.message="Загрузка...";var n,s=0,i=0,c={enableHighAccuracy:!0};"geolocation"in navigator?navigator.geolocation.getCurrentPosition(o,a,c):alert("Your browser doesnt support geolocation"),setInterval(function(){"geolocation"in navigator?navigator.geolocation.getCurrentPosition(o,a,c):alert("Your browser doesnt support geolocation"),e.$digest()},18e5),e.posts=r.getPosts(),e.addPost=function(){e.posts.$add({name:e.name,description:e.description,content:e.content,timestamp:Firebase.ServerValue.TIMESTAMP}),e.name="",e.description="",e.content=""}}]).controller("SendController",["$scope","fb",function(e,t){}]),app.factory("newsFactory",["$firebaseArray","fb",function(e,t){var r={};return r.getPosts=function(){var r=new Firebase(t.url+"news");return e(r)},r}]).factory("dashboardFactory",["$firebaseArray","fb",function(e,t){var r={};return r.getMetrics=function(r){var o=new Firebase(t.url+"metrics/"+r);return e(o)},r.getMetricsByWeek=function(r){var o=new Firebase(t.url+"metrics/"+r),a=o.limitToLast(7);return e(a)},r}]);