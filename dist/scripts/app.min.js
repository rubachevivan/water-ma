"use strict";var app=angular.module("waterApp",["ui.router","ngResource","firebase","chart.js"]).run(["$rootScope","$state","$firebaseAuth",function(e,t,a){e.$on("$stateChangeStart",function(e,o,r,n,i){var l=new Firebase("https://water-ma.firebaseio.com/"),s=a(l),c=s.$getAuth();o.authenticate&&!c&&(t.transitionTo("home"),e.preventDefault())})}]).constant("fb",{url:"https://water-ma.firebaseio.com/"}).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/home.html",controller:"HomeController"}},authenticate:!1}).state("login",{url:"/login",views:{content:{templateUrl:"views/login.html",controller:"LoginController"}},authenticate:!1}).state("dashboard",{url:"/dashboard",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/information.html",controller:"DashboardController"}},authenticate:!0}).state("send",{url:"/send",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/send.html",controller:"SendController"}},authenticate:!0}),t.otherwise("/")}]);app.controller("DashboardController",["$rootScope","$scope","dashboardFactory","newsFactory",function(e,t,a,o){function r(e,o){t[e+"Data"]=a.getMetricsByWeek(e),t[e+"Data"].$loaded().then(function(){t.$watchCollection(e+"Data",function(r,n){if(t[e+"Labels"]=[],t[e+"Series"]=[e],t[e+"CurrentMetrics"]=[[]],t[e+"Message"]="Показатели в норме.",r.forEach(function(a,o,r){var n,i=new Date(a.timestamp);switch(i.getDay()){case 0:n="Вс";break;case 1:n="Пн";break;case 2:n="Вт";break;case 3:n="Ср";break;case 4:n="Чт";break;case 5:n="Пт";break;case 6:n="Сб"}t[e+"Labels"][o]=n+", "+i.getDate(),t[e+"CurrentMetrics"][0][o]=a.contents}),t[e+"CurrentMetrics"][0][6]>o){var i=a.getQuality(e);i.$value=0,i.$save(),t[e+"Message"]="Внимание! Концентрация превышена."}else{var i=a.getQuality(e);i.$value=1,i.$save(),t[e+"Message"]="Концентрация в норме."}})})}t.biolMetrics=a.getMetrics("biol"),t.radMetrics=a.getMetrics("rad"),t.oilMetrics=a.getMetrics("oil"),t.addGood=function(e){t[e+"Metrics"].$add({contents:0,timestamp:Firebase.ServerValue.TIMESTAMP})},t.addBad=function(e){var a=Math.floor(10*Math.random());t[e+"Metrics"].$add({contents:a,timestamp:Firebase.ServerValue.TIMESTAMP})},e.waterState={},r("biol",0),r("rad",.1),t.oilData=a.getMetricsByWeek("oil"),t.oilData.$loaded().then(function(){t.$watchCollection("oilData",function(e,a){t.oilCurrentMetrics=[],t.oilLabels=["Нефть","Вода"],t.oilCurrentMetrics.push(+e[e.length-1].contents),t.oilCurrentMetrics.push(100-e[e.length-1].contents),console.log(t.oilCurrentMetrics[0]),t.oilCurrentMetrics[0]>20?t.oilMessage="Внимание! Концентрация превышена.":t.oilMessage="Концентрация в норме."})}),t.organData=a.getOrgan(),t.organData.$loaded().then(function(){console.log(t.organData),t.$watchCollection("organData",function(e,a){t.colorStyle="organGood",t.opacityStyle="organGood",t.smellStyle="organGood",t.tasteStyle="organGood",t.colour="Цветность воды в норме",t.opacity="Вода прозрачная",t.smell="Запах в порядке",t.taste="Привкус в порядке",e[0].color>=2&&(t.colour="Цветность воды не в порядке",t.colorStyle="organBad"),e[0].opacity>=2&&(t.opacity="Мутность высока",t.opacityStyle="organBad"),e[0].smell>=2&&(t.smell="Вода имеет неприятный запах",t.smellStyle="organBad"),e[0].taste>=2&&(t.taste="Вода имеет неприятный привкус",t.tasteStyle="organBad")})}),t.posts=o.getPosts(),t.addPost=function(){t.posts.$add({name:t.name,description:t.description,content:t.content,timestamp:Firebase.ServerValue.TIMESTAMP}),t.name="",t.description="",t.content=""}}]).controller("HomeController",["$scope","$resource","newsFactory","dashboardFactory",function(e,t,a,o){function r(a){s=a.coords.longitude,l=a.coords.latitude,i="http://api.openweathermap.org/data/2.5/weather?lat="+l+"&lon="+s+"&appid=44db6a862fba0b067b1930da0d769e98",console.log("current position is: "+l+" "+s),t(i).get().$promise.then(function(t){e.temperature=Math.round(t.main.temp-273),e.city=t.name,e.showWeather=!0;var a=t.weather[0].icon;"n"==a[a.length-1]?e.weathericon="wi wi-owm-night-"+t.weather[0].id:e.weathericon="wi-owm-day-"+t.weather[0].id},function(t){e.message="Error: "+t.status+" "+t.statusText})}function n(e){alert("error "+e.code+" "+e.message)}e.quality=o.getAllQuality(),e.quality.$loaded().then(function(){e.$watch("quality",function(t,a,o){e.waterState=t})}),e.showWeather=!1,e.message="Загрузка...";var i,l=0,s=0,c={enableHighAccuracy:!0};"geolocation"in navigator?navigator.geolocation.getCurrentPosition(r,n,c):alert("Your browser doesnt support geolocation"),setInterval(function(){"geolocation"in navigator?navigator.geolocation.getCurrentPosition(r,n,c):alert("Your browser doesnt support geolocation"),e.$digest()},18e5),e.posts=a.getPosts()}]).controller("SendController",["$scope","dashboardFactory",function(e,t){e.oilData=t.getMetrics("oil"),e.addOilData=function(){if(+e.oilContents>20){var a=t.getQuality("oil");a.$value=0,a.$save()}else{var a=t.getQuality("oil");a.$value=1,a.$save()}e.oilData.$add({contents:e.oilContents,comments:e.oilComment,timestamp:Firebase.ServerValue.TIMESTAMP}),e.oilContents="",e.oilComment=""},e.smell,e.taste,e.colour,e.opacity,e.organData=t.getMetrics("organ"),e.addOrganData=function(){if(e.smell>2||e.taste>2||e.colour>2||e.opacity>2){var a=t.getQuality("organ");a.$value=0,a.$save()}else{var a=t.getQuality("organ");a.$value=1,a.$save()}e.organData.$add({smell:+e.smell,taste:+e.taste,color:+e.colour,opacity:+e.opacity}),e.smell="",e.taste="",e.colour="",e.opacity=""}}]).controller("LoginController",["$scope","loginFactory",function(e,t){e.email,e.password,e.login=function(){t.$authWithPassword({email:e.email,password:e.password}).then(function(){console.log("YEEEY!")})["catch"](function(e){console.error("Authentication failed "+e)})}}]),app.factory("newsFactory",["$firebaseArray","fb",function(e,t){var a={};return a.getPosts=function(){var a=new Firebase(t.url+"news");return e(a)},a}]).factory("dashboardFactory",["$firebaseArray","$firebaseObject","fb",function(e,t,a){var o={};return o.getMetrics=function(t){var o=new Firebase(a.url+"metrics/"+t);return e(o)},o.getMetricsByWeek=function(t){var o=new Firebase(a.url+"metrics/"+t),r=o.limitToLast(7);return e(r)},o.getQuality=function(e){var o=new Firebase(a.url+"metrics/quality/"+e+"Quality");return t(o)},o.getAllQuality=function(){var e=new Firebase(a.url+"metrics/quality");return t(e)},o.getOrgan=function(){var t=new Firebase(a.url+"metrics/organ"),o=t.limitToLast(1);return e(o)},o}]).factory("loginFactory",["$firebaseAuth","fb",function(e,t){var a=new Firebase(t.url);return e(a)}]);